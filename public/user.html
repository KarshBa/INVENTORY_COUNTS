// public/js/user.js â€“ Inventory Counts front-end (CORRECTED)

/* ---------- DOM refs ---------- */
const listSelect   = document.getElementById('listSelect');
const newListName  = document.getElementById('newListName');
const createListBtn= document.getElementById('createListBtn');
const itemCodeEl   = document.getElementById('itemCode');
const selectBtn    = document.getElementById('selectBtn');
const detailsWrap  = document.getElementById('detailsWrap');
const brandEl      = document.getElementById('brand');
const descEl       = document.getElementById('desc');
const priceEl      = document.getElementById('price');
const customQtyEl  = document.getElementById('customQty');
const enterBtn     = document.getElementById('enterBtn');
const itemsTable   = document.querySelector('#itemsTable tbody');
const grandTotalEl = document.getElementById('grandTotal');

let masterItems = {};
const pad13 = c => String(c).padStart(13,'0');   // pad codes to 13 digits

/* ---------- initial load ---------- */
(async () => {
  await loadMaster();
  await loadLists();
})();

/* ---------- helper functions ---------- */
async function loadMaster() {
  const res = await fetch('/api/items');
  masterItems = await res.json();
}
async function loadLists() {
  const res   = await fetch('/api/lists');
  const lists = await res.json();
  listSelect.innerHTML = Object.keys(lists)
    .map(n => `<option value="${n}">${n}</option>`)
    .join('');
  if (Object.keys(lists).length) {
    listSelect.value = Object.keys(lists)[0];
    await renderList();
  }
}

/* ---------- create new list ---------- */
createListBtn.addEventListener('click', async () => {
  const name = newListName.value.trim();
  if (!name) return alert('Enter list name');
  const res = await fetch('/api/lists', {
    method : 'POST',
    headers: { 'Content-Type': 'application/json' },
    body   : JSON.stringify({ name })
  });
  if (res.ok) {
    await loadLists();
    listSelect.value = name;
    newListName.value = '';
  } else {
    alert('Could not create list');
  }
});

/* ---------- select item code ---------- */
selectBtn.addEventListener('click', async () => {
  const raw = itemCodeEl.value.trim();
  if (!raw) return alert('Enter item code');

  const code = pad13(raw);
  // Autofill custom entries if present
  const listRes = await fetch(`/api/lists/${listSelect.value}`);
  const thisList = await listRes.json();
  if (!masterItems[code] && thisList.items[code]) {
    masterItems[code] = thisList.items[code];
  }

  prepareDetails(code);
  detailsWrap.style.display = 'block';
  customQtyEl.focus();
});
itemCodeEl.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    selectBtn.click();
  }
});

function prepareDetails(code) {
  const m = masterItems[code] || {};
  const locked = !!masterItems[code];
  [brandEl, descEl, priceEl].forEach(el => el.readOnly = locked);
  brandEl.value = m.brand || '';
  descEl.value  = m.description || '';
  priceEl.value = m.price ?? '';
}

/* ---------- quantity controls ---------- */
document.querySelectorAll('button[data-delta]').forEach(btn => {
  btn.addEventListener('click', () => updateQty(parseInt(btn.dataset.delta,10)));
});
enterBtn.addEventListener('click', () => updateQty(parseInt(customQtyEl.value,10)));
customQtyEl.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    enterBtn.click();
  }
});

async function updateQty(delta) {
  if (!delta) return;
  const raw = itemCodeEl.value.trim();
  if (!raw) return;
  const code = pad13(raw);

  const payload = { itemCode: code, brand: brandEl.value, description: descEl.value, price: priceEl.value, delta };
  const res = await fetch(`/api/lists/${listSelect.value}/items`, {
    method : 'POST',
    headers: { 'Content-Type': 'application/json' },
    body   : JSON.stringify(payload)
  });
  if (res.ok) {
    resetForm();
    renderList();
  } else {
    alert('Server error');
  }
}

function resetForm() {
  itemCodeEl.value = '';
  customQtyEl.value = 1;
  detailsWrap.style.display = 'none';
  itemCodeEl.focus();
}

/* ---------- render list & mobile trim ---------- */
async function renderList() {
  const res = await fetch(`/api/lists/${listSelect.value}`);
  const data = await res.json();
  itemsTable.innerHTML = '';
  let grand = 0;
  data.items.forEach(it => { /* assuming items is an object */ });
  Object.values(data.items).forEach(it => {
    const total = it.qty * it.price;
    grand += total;
    itemsTable.insertAdjacentHTML('beforeend', `<tr><td>${it.code}</td><td>${it.brand}</td><td>${it.description}</td><td>${it.price.toFixed(2)}</td><td>${it.qty}</td><td>${total.toFixed(2)}</td></tr>`);
  });
  grandTotalEl.textContent = `Grand Total: $${grand.toFixed(2)}`;

  // mobile: keep only last 3
  if (window.innerWidth <= 600) {
    const rows = Array.from(itemsTable.children);
    if (rows.length > 3) {
      itemsTable.innerHTML = '';
      rows.slice(-3).forEach(r => itemsTable.appendChild(r));
    }
  }
}
