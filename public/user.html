<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventory Counts – User</title>
  <style>
    body {font-family: Arial, sans-serif;margin:0;padding:0;background:#f9f9f9;}
    header {background:#1a73e8;color:white;padding:1rem;text-align:center;}
    main {padding:1rem;max-width:800px;margin:auto;}
    .flex {display:flex;gap:.5rem;flex-wrap:wrap;}
    .input-group {margin-bottom:1rem;}
    label {display:block;margin-bottom:.25rem;}
    input[type=text], input[type=number] {width:100%;padding:.5rem;border:1px solid #ccc;border-radius:4px;}
    button {padding:.6rem 1rem;border:none;border-radius:4px;background:#1a73e8;color:white;font-size:1rem;}
    button.secondary {background:#ccc;color:#333;}
    table {width:100%;border-collapse:collapse;margin-top:1rem;}
    th, td {border:1px solid #ddd;padding:.5rem;text-align:left;}
    th {background:#eee;}
    @media (max-width:600px){
      table, thead, tbody, th, td, tr{display:block;}
      tr{margin-bottom:.75rem;}
      th{position:absolute;left:-9999px;}
      td{border:none;position:relative;padding-left:50%;}
      td::before{content:attr(data-label);position:absolute;left:0;width:45%;padding-left:.5rem;font-weight:bold;}
    }
  </style>
</head>
<body>
  <header>
    <h1>Inventory Counts – User</h1>
  </header>
  <main>
    <div class="input-group flex">
      <select id="listSelect"></select>
      <input type="text" id="newListName" placeholder="New list name" />
      <button id="createListBtn">Create</button>
    </div>

    <hr />

    <form id="itemForm">
      <div class="input-group">
        <label for="itemCode">Item Code</label>
        <input type="text" id="itemCode" required />
      </div>
      <div class="flex">
        <div style="flex:1;">
          <label for="brand">Brand</label>
          <input type="text" id="brand" />
        </div>
        <div style="flex:2;">
          <label for="desc">Description</label>
          <input type="text" id="desc" />
        </div>
      </div>
      <div class="input-group">
        <label for="price">Price</label>
        <input type="number" step="0.01" id="price" />
      </div>
      <div class="flex">
        <button type="button" data-delta="-5">-5</button>
        <button type="button" data-delta="-1">-1</button>
        <input type="number" id="customQty" value="1" style="max-width:80px;" />
        <button type="button" id="applyCustom">Apply</button>
        <button type="button" data-delta="1">+1</button>
        <button type="button" data-delta="5">+5</button>
      </div>
    </form>

    <table id="itemsTable">
      <thead>
        <tr><th>Code</th><th>Brand</th><th>Description</th><th>Price</th><th>Qty</th><th>Total</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <h3 id="grandTotal"></h3>
  </main>

<script>
const listSelect = document.getElementById('listSelect');
const newListName = document.getElementById('newListName');
const createListBtn = document.getElementById('createListBtn');
const itemCodeEl = document.getElementById('itemCode');
const brandEl = document.getElementById('brand');
const descEl = document.getElementById('desc');
const priceEl = document.getElementById('price');
const customQtyEl = document.getElementById('customQty');
const itemsTableBody = document.querySelector('#itemsTable tbody');
const grandTotalEl = document.getElementById('grandTotal');
let masterItems = {};

async function loadMaster() {
  const res = await fetch('/api/items');
  masterItems = await res.json();
}

async function loadLists() {
  const res = await fetch('/api/lists');
  const lists = await res.json();
  listSelect.innerHTML = Object.keys(lists).map(n=>`<option value="${n}">${n}</option>`).join('');
  if (!lists || Object.keys(lists).length===0) return;
  listSelect.value = Object.keys(lists)[0];
  renderList();
}

createListBtn.addEventListener('click', async ()=>{
  const name = newListName.value.trim();
  if (!name) return alert('Enter list name');
  const res = await fetch('/api/lists',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});
  if (res.ok){
    await loadLists();
    listSelect.value = name;
    newListName.value='';
  }else alert('Could not create list');
});

listSelect.addEventListener('change', renderList);

function setReadOnlyIfMaster(code){
  const master = masterItems[code];
  [brandEl,descEl,priceEl].forEach(el=>el.readOnly=!!master);
  if(master){
    brandEl.value=master.brand;
    descEl.value=master.description;
    priceEl.value=master.price;
  }
}

itemCodeEl.addEventListener('blur',()=>{
  setReadOnlyIfMaster(itemCodeEl.value.trim());
});

// quantity buttons
[...document.querySelectorAll('button[data-delta]')].forEach(btn=>{
  btn.addEventListener('click',()=>updateQuantity(parseInt(btn.dataset.delta,10)));
});

document.getElementById('applyCustom').addEventListener('click',()=>{
  updateQuantity(parseInt(customQtyEl.value,10));
});

async function updateQuantity(delta){
  const code = itemCodeEl.value.trim();
  if(!code) return alert('Enter item code');
  const payload={
    itemCode:code,
    brand:brandEl.value,
    description:descEl.value,
    price:priceEl.value,
    delta
  };
  const res = await fetch(`/api/lists/${listSelect.value}/items`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  if(res.ok){
    itemCodeEl.value='';brandEl.value='';descEl.value='';priceEl.value='';customQtyEl.value=1;
    setTimeout(renderList,100);
    itemCodeEl.focus();
  }else{
    alert('Error updating item');
  }
}

async function renderList(){
  if(!listSelect.value) return;
  const res = await fetch(`/api/lists/${listSelect.value}`);
  if(!res.ok) return;
  const list = await res.json();
  itemsTableBody.innerHTML='';
  let grand=0;
  Object.values(list.items).forEach(it=>{
    const total=it.qty*it.price;
    grand+=total;
    itemsTableBody.insertAdjacentHTML('beforeend',`<tr><td data-label="Code">${it.code}</td><td data-label="Brand">${it.brand}</td><td data-label="Desc">${it.description}</td><td data-label="Price">${it.price.toFixed(2)}</td><td data-label="Qty">${it.qty}</td><td data-label="Total">${total.toFixed(2)}</td></tr>`);
  });
  grandTotalEl.textContent = `Grand Total: $${grand.toFixed(2)}`;
}

(async ()=>{
  await loadMaster();
  await loadLists();
})();
</script>
</body>
</html>
