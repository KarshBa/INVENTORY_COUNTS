<!-- user.html – full script restored -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventory Counts – User</title>
  <style>
    :root{--accent:#1a73e8;--danger:#d93025;--radius:6px;--bg:#f9f9f9;}
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#202124;line-height:1.4;}
    header{background:var(--accent);color:#fff;padding:1rem;text-align:center;}
    main{padding:1rem;max-width:820px;margin:auto;}
    .flex{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;}
    .input-group{margin-bottom:1rem;width:100%;}
    label{display:block;margin-bottom:.25rem;font-weight:600;}
    input,select,button{font-size:1rem;border-radius:var(--radius);}  
    input[type=text],input[type=number],select{width:100%;padding:.55rem;border:1px solid #ccc;}
    button{padding:.65rem 1.2rem;border:none;background:var(--accent);color:#fff;cursor:pointer;min-width:44px;}
    button.secondary{background:#5f6368;}
    button:disabled{opacity:.5;cursor:not-allowed;}
    table{width:100%;border-collapse:collapse;margin-top:1rem;background:#fff;border-radius:var(--radius);overflow:hidden;}
    th,td{padding:.6rem;border:1px solid #e0e0e0;font-size:.95rem;text-align:left;}
    th{background:#f1f3f4;}
    @media(max-width:600px){
      table,thead,tbody,th,td,tr{display:block;width:100%;}
      thead{display:none;}
      tr{margin-bottom:.8rem;background:#fff;border-radius:var(--radius);box-shadow:0 1px 4px rgba(0,0,0,.1);}  
      td{border:none;position:relative;padding-left:50%;}
      td::before{content:attr(data-label);position:absolute;left:0;top:0;width:48%;padding:.6rem;font-weight:600;text-transform:capitalize;}
    }
  </style>
</head>
<body>
<header><h1>Inventory Counts</h1></header>
<main>
  <div class="input-group flex">
    <select id="listSelect" aria-label="Select list"></select>
    <input type="text" id="newListName" placeholder="New list name" />
    <button id="createListBtn">Create</button>
  </div>
  <hr />
  <form id="itemForm" autocomplete="off">
    <div class="input-group flex" style="align-items:flex-end;">
      <div style="flex:1;">
        <label for="itemCode">Item Code</label>
        <input type="text" id="itemCode" inputmode="numeric" pattern="[0-9]*" required autofocus />
      </div>
      <button type="button" id="selectBtn" class="secondary" style="height:42px;">Select</button>
    </div>
    <div id="detailsWrap" style="display:none;">
      <div class="flex">
        <div style="flex:1;min-width:120px;">
          <label for="brand">Brand</label>
          <input type="text" id="brand" />
        </div>
        <div style="flex:2;">
          <label for="desc">Description</label>
          <input type="text" id="desc" />
        </div>
      </div>
      <div class="input-group" style="max-width:200px;">
        <label for="price">Price</label>
        <input type="number" step="0.01" id="price" />
      </div>
      <div class="flex" style="margin-top:.5rem;align-items:flex-end;">
        <button type="button" data-delta="-5">-5</button>
        <button type="button" data-delta="-1">-1</button>
        <input type="number" id="customQty" value="1" style="width:90px;" />
        <button type="button" id="enterBtn" class="secondary">Enter</button>
        <button type="button" data-delta="1">+1</button>
        <button type="button" data-delta="5">+5</button>
      </div>
    </div>
  </form>

  <table id="itemsTable">
    <thead>
      <tr><th>Code</th><th>Brand</th><th>Description</th><th>Price</th><th>Qty</th><th>Total</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <h3 id="grandTotal"></h3>
</main>

<script>
// ---------- DOM refs ----------
const listSelect=document.getElementById('listSelect');
const newListName=document.getElementById('newListName');
const createListBtn=document.getElementById('createListBtn');
const itemCodeEl=document.getElementById('itemCode');
const selectBtn=document.getElementById('selectBtn');
const detailsWrap=document.getElementById('detailsWrap');
const brandEl=document.getElementById('brand');
const descEl=document.getElementById('desc');
const priceEl=document.getElementById('price');
const customQtyEl=document.getElementById('customQty');
const enterBtn=document.getElementById('enterBtn');
const itemsTableBody=document.querySelector('#itemsTable tbody');
const grandTotalEl=document.getElementById('grandTotal');

let masterItems={};

(async()=>{await loadMaster();await loadLists();})();

async function loadMaster(){const r=await fetch('/api/items');masterItems=await r.json();}
async function loadLists(){const r=await fetch('/api/lists');const lists=await r.json();listSelect.innerHTML=Object.keys(lists).map(n=>`<option value="${n}">${n}</option>`).join('');if(Object.keys(lists).length){listSelect.value=Object.keys(lists)[0];renderList();}}

createListBtn.addEventListener('click',async()=>{const name=newListName.value.trim();if(!name)return alert('Enter list name');const res=await fetch('/api/lists',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});if(res.ok){await loadLists();listSelect.value=name;newListName.value='';}else alert('Create failed');});
listSelect.addEventListener('change',renderList);

selectBtn.addEventListener('click',()=>{const code=itemCodeEl.value.trim();if(!code)return alert('Enter item code');prepareDetails(code);detailsWrap.style.display='block';customQtyEl.focus();});
itemCodeEl.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();selectBtn.click();}});

function prepareDetails(code){const master=masterItems[code];const lock=!!master;[brandEl,descEl,priceEl].forEach(el=>el.readOnly=lock);if(master){brandEl.value=master.brand||'';descEl.value=master.description||'';priceEl.value=master.price??'';}else{brandEl.value='';descEl.value='';priceEl.value='';}}

[...document.querySelectorAll('button[data-delta]')].forEach(b=>b.addEventListener('click',()=>updateQty(parseInt(b.dataset.delta,10))));
enterBtn.addEventListener('click',()=>updateQty(parseInt(customQtyEl.value,10)));
customQtyEl.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();enterBtn.click();}});

async function updateQty(delta){if(!delta)return;const code=itemCodeEl.value.trim();if(!code)return;const payload={itemCode:code,brand:brandEl.value,description:descEl.value,price:priceEl.value,delta};const res=await fetch(`/api/lists/${listSelect.value}/items`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(res.ok){resetForm();renderList();}else alert('Server error');}

function resetForm(){itemCodeEl.value='';detailsWrap.style.display='none';customQtyEl.value=1;itemCodeEl.focus();}

async function renderList(){if(!listSelect.value)return;const res=await fetch(`/api/lists/${listSelect.value}`);if(!res.ok)return;const list=await res.json();itemsTableBody.innerHTML='';let grand=0;Object.values(list.items).forEach(it=>{const t=it.qty*it.price;grand+=t;itemsTableBody.insertAdjacentHTML('beforeend',`
